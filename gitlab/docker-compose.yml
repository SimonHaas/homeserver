version: '3'

networks:
    web:
        external: true

services:
    # The reverse proxy service (Traefik)
    traefik:
        image: traefik:1.7 # The official Traefik docker image
        command: --api --docker # Enables the web UI and tells Traefik to listen to docker
        restart: always
        networks:
            - web
        env_file:
            - .env
        ports:
            - "80:80"
            - "443:443"
            - "9000:9000" # exposes the Traefik web UI
        volumes:
            - "/var/run/docker.sock:/var/run/docker.sock" # So that Traefik can listen to the Docker events
            - "./traefik.toml:/traefik.toml"
            - "./acme.json:/acme.json"
        container_name: traefik

    # The GitLab container itself
    gitlab:
        image: 'gitlab/gitlab-ce:latest'
        restart: always
        hostname: 'gitlab.simonhaas.eu'
        environment:
            GITLAB_OMNIBUS_CONFIG: |
                external_url 'https://gitlab.simonhaas.eu'
                nginx['listen_https'] = false
                nginx['listen_port'] = 80
        volumes:
            - './config:/etc/gitlab'
            - './logs:/var/log/gitlab'
            - './data:/var/opt/gitlab'
        networks:
            - web
        ports:
            - "2222:22" # expose GitLab SSH on port 2222 on the host, as Traefik does not yet support TCP routing
        labels:
            - "traefik.frontend.rule=Host:gitlab.simonhaas.eu"
            - "traefik.docker.network=web"
            - "traefik.enable=true"
            - "traefik.port=80"
            - "traefik.protocol=http"
